<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Services Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #2563eb;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .test-result.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .test-result.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        #test-canvas {
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        .log-item {
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-item.info { background-color: #dbeafe; }
        .log-item.success { background-color: #d1fae5; }
        .log-item.warning { background-color: #fef3c7; }
        .log-item.error { background-color: #fee2e2; }
    </style>
</head>
<body>
    <h1>Phase 2 Services Test Suite</h1>

    <div class="test-section">
        <h2>LoggerService Tests</h2>
        <div id="logger-results"></div>
    </div>

    <div class="test-section">
        <h2>MarkerRenderer Tests</h2>
        <canvas id="test-canvas" width="400" height="300"></canvas>
        <div id="marker-results"></div>
    </div>

    <div class="test-section">
        <h2>ScreenInteractionHandler Tests</h2>
        <div id="interaction-results"></div>
    </div>

    <div class="test-section">
        <h2>ActionConfigProvider Tests</h2>
        <div id="config-results"></div>
    </div>

    <div class="test-section">
        <h2>Logger Output</h2>
        <div id="log-output"></div>
    </div>

    <!-- Load Services -->
    <script src="src/renderer/services/EventBus.js"></script>
    <script src="src/renderer/coordinate-system.js"></script>
    <script src="src/renderer/services/LoggerService.js"></script>
    <script src="src/renderer/services/CoordinateService.js"></script>
    <script src="src/renderer/services/MarkerRenderer.js"></script>
    <script src="src/renderer/services/ScreenInteractionHandler.js"></script>
    <script src="src/renderer/services/ActionConfigProvider.js"></script>

    <script>
        // Test utilities
        function addResult(containerId, message, success = true) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'success' : 'error'}`;
            div.textContent = success ? `✓ ${message}` : `✗ ${message}`;
            container.appendChild(div);
        }

        function addLog(entry) {
            const container = document.getElementById('log-output');
            const div = document.createElement('div');
            div.className = `log-item ${entry.level}`;
            div.textContent = `[${entry.time}] [${entry.level.toUpperCase()}] ${entry.message}`;
            container.appendChild(div);
        }

        // Test 1: LoggerService
        function testLoggerService() {
            try {
                const logger = new LoggerService({ maxLogs: 100 });

                // Subscribe to logs
                const unsubscribe = logger.subscribe(entry => {
                    addLog(entry);
                });

                // Test logging methods
                logger.info('Info message test');
                logger.success('Success message test');
                logger.warning('Warning message test');
                logger.error('Error message test');
                logger.debug('Debug message test');

                if (logger.logs.length !== 5) {
                    throw new Error(`Expected 5 logs, got ${logger.logs.length}`);
                }

                addResult('logger-results', 'Log methods work correctly', true);

                // Test filtering
                logger.setFilterLevels(['error', 'warning']);
                logger.info('This should not be logged');

                if (logger.logs.length !== 5) {
                    throw new Error('Filter not working');
                }

                addResult('logger-results', 'Log filtering works', true);

                // Reset filter for scoped logger test
                logger.setFilterLevels(['info', 'success', 'warning', 'error', 'debug']);

                // Test scoped logger
                const scopedLogger = logger.createScope('TEST');
                scopedLogger.info('Scoped message');

                const lastLog = logger.logs[logger.logs.length - 1];
                if (!lastLog.message.includes('[TEST]')) {
                    throw new Error('Scoped logger not working');
                }

                addResult('logger-results', 'Scoped logger works', true);

                // Test statistics
                const stats = logger.getStatistics();
                if (stats.total !== 6) {
                    throw new Error(`Expected 6 total logs, got ${stats.total}`);
                }

                addResult('logger-results', 'Statistics calculation works', true);

                // Test export
                const jsonExport = logger.exportJSON();
                if (!jsonExport || typeof jsonExport !== 'string') {
                    throw new Error('JSON export failed');
                }

                const csvExport = logger.exportCSV();
                if (!csvExport || !csvExport.includes('Timestamp,Level,Message')) {
                    throw new Error('CSV export failed');
                }

                addResult('logger-results', 'Export functions work', true);

                unsubscribe();
                addResult('logger-results', 'All LoggerService tests passed', true);

            } catch (error) {
                addResult('logger-results', `LoggerService test failed: ${error.message}`, false);
            }
        }

        // Test 2: MarkerRenderer
        function testMarkerRenderer() {
            try {
                const canvas = document.getElementById('test-canvas');
                const coordinateSystem = {
                    device: { width: 1920, height: 1080 }
                };
                const coordinateService = new CoordinateService(coordinateSystem);
                const markerRenderer = new MarkerRenderer(canvas, coordinateService);

                // Test adding marker
                const markerId = markerRenderer.addMarker({ x: 100, y: 100 }, {
                    type: 'click',
                    color: '#2563eb',
                    label: 'Test Marker'
                });

                if (!markerId) {
                    throw new Error('Failed to add marker');
                }

                if (markerRenderer.getMarkers().length !== 1) {
                    throw new Error('Marker not added to list');
                }

                addResult('marker-results', 'Marker addition works', true);

                // Test drag line
                markerRenderer.setDragLine(
                    { x: 50, y: 50 },
                    { x: 200, y: 200 },
                    { color: '#2563eb' }
                );

                if (!markerRenderer.dragLine) {
                    throw new Error('Drag line not set');
                }

                addResult('marker-results', 'Drag line rendering works', true);

                // Test region
                markerRenderer.setRegion(
                    { x: 10, y: 10, width: 100, height: 100 },
                    { color: '#ca8a04', label: 'Test Region' }
                );

                if (!markerRenderer.region) {
                    throw new Error('Region not set');
                }

                addResult('marker-results', 'Region overlay works', true);

                // Test clear
                markerRenderer.clear();
                if (markerRenderer.getMarkers().length !== 0) {
                    throw new Error('Markers not cleared');
                }

                addResult('marker-results', 'Clear function works', true);

                // Test get marker at position
                markerRenderer.addMarker({ x: 150, y: 150 }, { type: 'click' });
                const marker = markerRenderer.getMarkerAt(155, 155, 10);

                if (!marker) {
                    throw new Error('Failed to get marker at position');
                }

                addResult('marker-results', 'Marker position detection works', true);

                addResult('marker-results', 'All MarkerRenderer tests passed', true);

            } catch (error) {
                addResult('marker-results', `MarkerRenderer test failed: ${error.message}`, false);
            }
        }

        // Test 3: ScreenInteractionHandler
        function testScreenInteractionHandler() {
            try {
                const canvas = document.getElementById('test-canvas');
                const coordinateSystem = {
                    device: { width: 1920, height: 1080 }
                };
                const coordinateService = new CoordinateService(coordinateSystem);
                const markerRenderer = new MarkerRenderer(canvas, coordinateService);
                const eventBus = new EventBus();

                const handler = new ScreenInteractionHandler(
                    canvas,
                    coordinateService,
                    markerRenderer,
                    eventBus
                );

                // Test mode setting
                handler.setMode('click');
                if (handler.getMode() !== 'click') {
                    throw new Error('Mode not set correctly');
                }

                addResult('interaction-results', 'Mode setting works', true);

                // Test state
                const state = handler.getState();
                if (!state || state.mode !== 'click') {
                    throw new Error('State retrieval failed');
                }

                addResult('interaction-results', 'State retrieval works', true);

                // Test event bus integration
                let eventReceived = false;
                eventBus.on('interaction:mode-changed', (data) => {
                    if (data.mode === 'drag') {
                        eventReceived = true;
                    }
                });

                handler.setMode('drag');

                if (!eventReceived) {
                    throw new Error('Event bus integration not working');
                }

                addResult('interaction-results', 'Event bus integration works', true);

                // Test reset
                handler.reset();
                if (handler.isDrawing) {
                    throw new Error('Reset not working');
                }

                addResult('interaction-results', 'Reset function works', true);

                addResult('interaction-results', 'All ScreenInteractionHandler tests passed', true);

            } catch (error) {
                addResult('interaction-results', `ScreenInteractionHandler test failed: ${error.message}`, false);
            }
        }

        // Test 4: ActionConfigProvider
        function testActionConfigProvider() {
            try {
                const provider = new ActionConfigProvider();

                // Test get action type
                const clickType = provider.getActionType('click');
                if (!clickType || clickType.name !== 'Click') {
                    throw new Error('Failed to get action type');
                }

                addResult('config-results', 'Action type retrieval works', true);

                // Test get all action types
                const allTypes = provider.getAllActionTypes();
                if (!Array.isArray(allTypes) || allTypes.length === 0) {
                    throw new Error('Failed to get all action types');
                }

                addResult('config-results', `Retrieved ${allTypes.length} action types`, true);

                // Test get by category
                const basicActions = provider.getActionTypesByCategory('basic');
                if (!Array.isArray(basicActions) || basicActions.length === 0) {
                    throw new Error('Failed to get actions by category');
                }

                addResult('config-results', 'Category filtering works', true);

                // Test get categories
                const categories = provider.getAllCategories();
                if (!Array.isArray(categories) || categories.length === 0) {
                    throw new Error('Failed to get categories');
                }

                addResult('config-results', `Retrieved ${categories.length} categories`, true);

                // Test default params
                const defaultParams = provider.getDefaultParams('click');
                if (!defaultParams || typeof defaultParams.x !== 'number') {
                    throw new Error('Default params not correct');
                }

                addResult('config-results', 'Default parameters work', true);

                // Test validation
                const validAction = {
                    type: 'click',
                    x: 100,
                    y: 200
                };

                const validResult = provider.validateAction(validAction);
                if (!validResult.valid) {
                    throw new Error('Valid action marked as invalid');
                }

                addResult('config-results', 'Validation for valid actions works', true);

                // Test invalid action
                const invalidAction = {
                    type: 'click'
                    // Missing x and y
                };

                const invalidResult = provider.validateAction(invalidAction);
                if (invalidResult.valid) {
                    throw new Error('Invalid action marked as valid');
                }

                addResult('config-results', 'Validation for invalid actions works', true);

                // Test display name
                const displayName = provider.getDisplayName(validAction);
                if (!displayName || !displayName.includes('100')) {
                    throw new Error('Display name not correct');
                }

                addResult('config-results', 'Display name generation works', true);

                // Test execution time estimation
                const execTime = provider.getEstimatedExecutionTime(validAction);
                if (typeof execTime !== 'number') {
                    throw new Error('Execution time estimation failed');
                }

                addResult('config-results', 'Execution time estimation works', true);

                // Test helper methods
                if (!provider.requiresCoordinates('click')) {
                    throw new Error('requiresCoordinates not working');
                }

                if (!provider.isControlFlow('if')) {
                    throw new Error('isControlFlow not working');
                }

                if (!provider.isTestingAction('test')) {
                    throw new Error('isTestingAction not working');
                }

                addResult('config-results', 'Helper methods work', true);

                addResult('config-results', 'All ActionConfigProvider tests passed', true);

            } catch (error) {
                addResult('config-results', `ActionConfigProvider test failed: ${error.message}`, false);
            }
        }

        // Run all tests
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testLoggerService();
                testMarkerRenderer();
                testScreenInteractionHandler();
                testActionConfigProvider();
            }, 100);
        });
    </script>
</body>
</html>
