<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data:; img-src 'self' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' data:">
    <title>AVANT</title>
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/typography.css">
    <link rel="stylesheet" href="styles/colors.css">
    <link rel="stylesheet" href="styles/panels.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/macro-builder.css">
    <link rel="stylesheet" href="styles/sound-check.css">
</head>
<body>
    <div id="app" class="h-screen flex bg-slate-50">
        <!-- Scenario Sidebar -->
        <div id="scenario-sidebar" class="scenario-sidebar">
            <div class="scenario-sidebar-header">
                <h3 class="scenario-sidebar-title">시나리오 목록</h3>
                <button id="btn-close-sidebar" class="btn-icon">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="scenario-sidebar-actions">
                <button class="btn-outline btn-sm" id="btn-new-folder">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                    </svg>
                    새 폴더
                </button>
                <button class="btn-primary btn-sm" id="btn-new-scenario">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    새 시나리오
                </button>
            </div>
            <div class="scenario-sidebar-content">
                <div id="scenario-tree-container">
                    <!-- Scenario tree will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <!-- New Scenario Dialog -->
        <div id="new-scenario-dialog" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">새 시나리오</h3>
                    <button id="btn-close-dialog" class="modal-close">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <label class="input-label">시나리오 이름</label>
                    <input type="text" id="scenario-name-input" class="input" placeholder="시나리오 이름을 입력하세요..." />
                    <div id="dialog-filename-preview" style="margin-top: 8px; font-size: 12px; color: #64748b;">
                        파일명: <span id="dialog-filename-preview-text" style="font-family: 'Courier New', monospace; color: #64748b;">unnamed.json</span>
                    </div>
                    <p id="scenario-name-error" class="input-error" style="display: none;"></p>
                </div>
                <div class="modal-footer">
                    <button id="btn-cancel-scenario" class="btn-sm btn-outline">취소</button>
                    <button id="btn-create-scenario" class="btn-sm btn-primary">생성</button>
                </div>
            </div>
        </div>

        <!-- Add Action Prompt Dialog -->
        <div id="add-action-prompt-dialog" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 480px;">
                <div class="modal-header">
                    <h3 class="modal-title">액션 추가하기</h3>
                    <button id="btn-close-prompt-dialog" class="modal-close">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; padding: 1rem 0;">
                        <svg style="width: 64px; height: 64px; margin: 0 auto 1rem; color: var(--blue-500);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                        </svg>
                        <p style="font-size: 1.125rem; font-weight: 600; color: var(--slate-900); margin-bottom: 0.5rem;">시나리오가 생성되었습니다</p>
                        <p style="font-size: 0.875rem; color: var(--slate-600); line-height: 1.5;">오른쪽 패널에서 액션을 선택하여<br>시나리오에 추가해보세요</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btn-confirm-prompt" class="btn-sm btn-primary" style="width: 100%;">확인</button>
                </div>
            </div>
        </div>

        <!-- Main Content - 3 Column Layout: Scenario | Action (slide) | Preview -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Panel - Scenario Section -->
            <div class="flex-1 bg-slate-50 border-r flex flex-col" id="macro-sequence-container" style="min-width: 400px;">
                <!-- Panel Header: List View -->
                <div class="panel-header" id="scenario-list-header">
                    <div>
                        <h2 class="panel-title">시나리오 목록</h2>
                        <p class="panel-subtitle">시나리오를 선택하여 편집하거나 실행할 수 있습니다</p>
                    </div>
                </div>

                <!-- Panel Header: Edit View (hidden by default) -->
                <div class="panel-header" id="scenario-edit-header" style="display: none;">
                    <div>
                        <h2 class="panel-title">시나리오 편집</h2>
                        <p class="panel-subtitle">액션을 추가하여 시나리오를 구성하세요</p>
                    </div>
                </div>
                <!-- Panel Toolbar -->
                <div class="panel-toolbar" id="toolbar-buttons">
                    <!-- Left side: Primary actions -->
                    <div class="flex items-center gap-2">
                        <!-- Edit View: Back button -->
                        <button class="btn-outline btn-sm" id="btn-back-to-list" style="display: none;">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            목록으로
                        </button>

                        <!-- List View: New scenario button -->
                        <button class="btn-outline btn-sm" id="btn-new-scenario" onclick="window.macroApp.createNewScenario()">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            새 시나리오
                        </button>

                    </div>

                    <!-- Right side: Secondary actions -->
                    <div class="flex items-center gap-2">
                        <!-- Global Settings Button -->
                        <button class="btn-outline btn-sm" id="btn-global-settings" title="결과 저장 설정">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            설정
                        </button>

                        <!-- Edit View: Save buttons -->
                        <button class="btn-outline btn-sm" id="btn-save-macro" style="display: none;">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                            </svg>
                            저장
                        </button>

                        <!-- Delay select (shown in both list and edit views) -->
                        <div id="delay-select-wrapper" class="flex items-center gap-2">
                            <label class="toolbar-label">지연:</label>
                            <select id="toolbar-delay-select" class="btn-outline btn-sm" style="min-width: 90px;">
                                <option value="0">없음</option>
                                <option value="100">100ms</option>
                                <option value="300" selected>300ms</option>
                                <option value="500">500ms</option>
                                <option value="1000">1s</option>
                                <option value="1500">1.5s</option>
                            </select>
                        </div>

                        <!-- Run buttons -->
                        <button class="btn-primary btn-sm" id="btn-run-macro" style="display: none;">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            실행
                        </button>
                        <!-- List View: Run selected scenarios -->
                        <button class="btn-primary btn-sm" id="btn-run-selected">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            선택 실행
                        </button>
                        <!-- Edit View: Run selected actions -->
                        <button class="btn-primary btn-sm" id="btn-run-selected-actions" style="display: none;">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            선택 실행
                        </button>
                        <!-- Edit View: Infinite loop -->
                        <button class="btn-outline btn-sm" id="btn-infinite-loop" style="display: none;" title="무한 반복 실행">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            무한 반복
                        </button>
                        <button class="btn-danger btn-sm" id="btn-delete-selected">
                            선택 삭제
                        </button>
                    </div>
                </div>


                <!-- Panel Content -->
                <div class="panel-content" id="action-sequence-list">
                    <!-- Scenario Info (Edit View only, hidden by default) -->
                    <div id="macro-name-container" style="display: none; padding-bottom: 20px; border-bottom: 1px solid var(--color-border); margin-bottom: 20px;">
                        <!-- Scenario Title Display -->
                        <h3 id="scenario-title-display" style="font-size: 1.25rem; font-weight: 600; color: var(--slate-900); margin-bottom: 16px;">
                            새 시나리오
                        </h3>

                        <div class="flex-1">
                            <label class="setting-label" style="display: block; margin-bottom: 8px;">시나리오 이름</label>
                            <input
                                type="text"
                                id="macro-name-input"
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="시나리오 이름"
                                value="새 시나리오"
                            />
                            <div id="filename-preview" class="text-xs text-slate-400 mt-1 font-mono">
                                파일명: <span id="filename-preview-text">새_시나리오.json</span>
                            </div>

                            <label class="setting-label" style="display: block; margin-top: 12px; margin-bottom: 8px;">시나리오 설명 (선택사항)</label>
                            <input
                                type="text"
                                id="macro-description-input"
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="시나리오 설명"
                            />
                        </div>
                    </div>

                    <!-- Save buttons row (shown in edit view) -->
                    <div id="save-buttons-row" style="display: none; padding-bottom: 16px; border-bottom: 1px solid var(--color-border); margin-bottom: 16px;">
                        <div class="flex gap-2">
                            <button class="btn-primary btn-sm flex-1" id="btn-save-macro-inline" disabled>
                                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                저장
                            </button>
                            <button class="btn-outline btn-sm flex-1" id="btn-save-as-macro-inline">
                                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                다른 이름으로 저장
                            </button>
                        </div>
                    </div>

                    <!-- Empty state (hidden by default, shown by JavaScript) -->
                    <div class="empty-state" id="empty-state" style="display: none;">
                        <svg class="empty-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p class="empty-title">시나리오가 비어있습니다</p>
                        <p class="empty-description">오른쪽에서 액션을 선택하여 시작하세요</p>
                    </div>
                    <!-- Action blocks will be rendered here -->
                </div>
            </div>

            <!-- Middle Panel - Action List (slides in from right) -->
            <div id="action-panel" class="flex-1 bg-white border-r flex flex-col hidden" style="min-width: 450px;">
                <!-- Panel Header -->
                <div class="panel-header">
                    <div>
                        <h2 class="panel-title">액션 목록</h2>
                        <p class="panel-subtitle">시나리오에 추가할 액션 선택</p>
                    </div>
                </div>

                <!-- Panel Toolbar -->
                <div class="panel-toolbar">
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 text-sm text-slate-600">
                            <input type="checkbox" id="option-instant-execute" checked class="w-4 h-4 rounded border-slate-300 text-blue-600">
                            <span>즉시 실행</span>
                        </label>
                    </div>
                </div>

                <!-- Panel Content -->
                <div class="panel-content" id="action-list-container">

                    <!-- Tabs - New 4-category system -->
                    <div class="tabs mb-4">
                        <div class="tabs-list grid grid-cols-4">
                            <button class="tab active" data-tab="actions">액션</button>
                            <button class="tab" data-tab="conditions">조건</button>
                            <button class="tab" data-tab="flow">흐름</button>
                            <button class="tab" data-tab="exit">종료</button>
                        </div>
                    </div>

                    <!-- Tab Contents -->
                    <div class="tab-content active" data-tab="actions" id="actions-actions">
                        <!-- Action commands will be rendered here -->
                    </div>
                    <div class="tab-content hidden" data-tab="conditions" id="conditions-actions">
                        <!-- Condition starters will be rendered here -->
                    </div>
                    <div class="tab-content hidden" data-tab="flow" id="flow-actions">
                        <!-- Flow control will be rendered here -->
                    </div>
                    <div class="tab-content hidden" data-tab="exit" id="exit-actions">
                        <!-- Exit states will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Right Panel - Screen Preview -->
            <div id="screen-preview-panel" class="flex-1 bg-white flex flex-col">
                <!-- Panel Header -->
                <div class="panel-header">
                    <div>
                        <h2 class="panel-title">스크린 프리뷰</h2>
                        <p class="panel-subtitle">화면을 클릭하여 좌표 설정</p>
                    </div>
                </div>

                <!-- Panel Toolbar -->
                <div class="panel-toolbar" id="screen-toolbar">
                    <div class="flex items-center gap-3">
                        <!-- Device Info -->
                        <div class="device-status-container" id="device-status">
                            <div class="device-status-indicator">
                                <div class="status-light disconnected" id="status-light"></div>
                                <span class="device-status-value" id="device-name-value">--</span>
                            </div>
                            <div class="device-status-divider"></div>
                            <div class="device-status-indicator">
                                <span class="device-status-label">RES</span>
                                <span class="device-status-value" id="device-res-value">--</span>
                            </div>
                            <div class="device-status-divider"></div>
                            <div class="device-status-indicator">
                                <span class="device-status-label">FPS</span>
                                <span class="device-status-value" id="device-fps-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <!-- Marker Toggle -->
                        <label class="flex items-center gap-2 text-sm text-slate-600">
                            <input type="checkbox" id="option-show-markers" checked class="w-4 h-4 rounded border-slate-300 text-blue-600">
                            <span>좌표 마커</span>
                        </label>

                        <!-- Auto Reconnect Toggle -->
                        <label class="flex items-center gap-2 text-sm text-slate-600">
                            <input type="checkbox" id="option-auto-reconnect" class="w-4 h-4 rounded border-slate-300 text-blue-600">
                            <span>자동 재연결</span>
                        </label>

                        <!-- Screen Pause Toggle -->
                        <button class="btn-outline btn-sm" id="btn-pause-screen">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            일시정지
                        </button>

                        <!-- Screen Reconnect Button -->
                        <button class="btn-outline btn-sm" id="btn-reconnect-screen" title="화면 크기가 잘못되었을 때 재연결">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            재연결
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto p-6" id="screen-preview-container">
                    <!-- Device Connection UI (shown when no device connected) -->
                    <div id="device-connection-ui" class="device-connection-container">
                        <div class="device-connection-content">
                            <svg class="device-connection-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="device-connection-title">장치 연결이 필요합니다</h3>
                            <p class="device-connection-description">AVN 검증을 시작하려면 테스트 장치를 연결하세요</p>

                            <div class="device-connection-methods">
                                <div class="device-method-card">
                                    <div class="device-method-header">
                                        <svg class="device-method-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        <div>
                                            <h4 class="device-method-title">ADB 장치</h4>
                                            <p class="device-method-description">connect-S</p>
                                        </div>
                                    </div>
                                    <button class="device-connect-button" id="btn-connect-adb">
                                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        ADB 연결
                                    </button>
                                </div>

                                <div class="device-method-card">
                                    <div class="device-method-header">
                                        <svg class="device-method-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                        <div>
                                            <h4 class="device-method-title">iSAP 장치</h4>
                                            <p class="device-method-description">ccNC, ccRC, ccIC 등</p>
                                        </div>
                                    </div>
                                    <button class="device-connect-button" id="btn-connect-isap">
                                        <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        iSAP 연결
                                    </button>
                                </div>
                            </div>

                            <div class="device-connection-note">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span>장치를 USB로 연결하거나 무선 네트워크에서 연결 가능합니다</span>
                            </div>
                        </div>
                    </div>
                    <!-- Screen preview will be rendered here when device connected -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Stores -->
    <script src="stores/BaseStore.js"></script>
    <script src="stores/DeviceStore.js"></script>
    <script src="stores/ScreenStore.js"></script>
    <script src="stores/MacroStore.js"></script>
    <script src="stores/ActionStore.js"></script>

    <!-- Services -->
    <script src="services/EventBus.js"></script>
    <script src="services/IPCService.js"></script>

    <!-- New Refactored Services - Phase 1 -->
    <script src="services/ActionService.js"></script>
    <script src="services/CoordinateService.js"></script>
    <script src="services/MacroExecutor.js"></script>

    <!-- New Refactored Services - Phase 2 -->
    <script src="services/LoggerService.js"></script>
    <script src="services/MarkerRenderer.js"></script>
    <script src="services/ScreenInteractionHandler.js"></script>
    <script src="services/ActionConfigProvider.js"></script>
    <script src="services/ActionPluginSystem.js"></script>

    <!-- Controllers - Phase 3 -->
    <script src="controllers/MacroBuilderController.js"></script>

    <!-- Utils - Phase 3 Refactoring -->
    <script src="utils/TemplateHelpers.js"></script>

    <!-- Builders - Phase 2 Refactoring -->
    <script src="builders/UIComponents.js"></script>
    <script src="builders/ActionSettingsBuilder.js"></script>

    <!-- View System - Phase 4 Refactoring -->
    <script src="views/BaseView.js"></script>
    <script src="views/ViewManager.js"></script>
    <script src="views/left/ScenarioListView.js"></script>
    <script src="views/left/ActionEditorView.js"></script>
    <script src="views/panels/LeftPanelView.js"></script>
    <script src="views/index.js"></script>

    <!-- Coordinate System -->
    <script src="coordinate-system.js"></script>

    <!-- Image Matcher -->
    <script src="js/image-matcher.js"></script>

    <!-- Audio Capture -->
    <script src="utils/audio-capture.js"></script>

    <!-- Sound Check Modal -->
    <script src="components/sound-check-modal.js"></script>

    <!-- Screen Alert Overlay -->
    <script src="components/ScreenAlertOverlay.js"></script>

    <!-- Global Settings Modal -->
    <div id="global-settings-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">결과 저장 설정</h3>
                <button id="btn-close-settings-modal" class="modal-close">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- On Failure Settings -->
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 14px; font-weight: 600; color: var(--red-600); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        실패 시 저장
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 10px; padding-left: 12px;">
                        <label class="flex items-center gap-2 text-sm text-slate-600" style="cursor: pointer;">
                            <input type="checkbox" id="save-on-fail-screenshot" class="w-4 h-4 rounded border-slate-300 text-blue-600" checked>
                            <span>스크린샷</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-600" style="cursor: pointer;">
                            <input type="checkbox" id="save-on-fail-log" class="w-4 h-4 rounded border-slate-300 text-blue-600" checked>
                            <span>실행 로그</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-600" style="cursor: pointer;">
                            <input type="checkbox" id="save-on-fail-variables" class="w-4 h-4 rounded border-slate-300 text-blue-600" checked>
                            <span>변수값</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-600" style="cursor: pointer;">
                            <input type="checkbox" id="save-on-fail-match-image" class="w-4 h-4 rounded border-slate-300 text-blue-600" checked>
                            <span>매칭 이미지 (이미지 매칭 실패 시)</span>
                        </label>
                    </div>
                </div>

                <!-- On Success Settings -->
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 14px; font-weight: 600; color: var(--green-600); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        성공 시 저장
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 10px; padding-left: 12px;">
                        <label class="flex items-center gap-2 text-sm text-slate-600" style="cursor: pointer;">
                            <input type="checkbox" id="save-on-success-screenshot" class="w-4 h-4 rounded border-slate-300 text-blue-600">
                            <span>스크린샷</span>
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-600" style="cursor: pointer;">
                            <input type="checkbox" id="save-on-success-log" class="w-4 h-4 rounded border-slate-300 text-blue-600">
                            <span>실행 로그</span>
                        </label>
                    </div>
                </div>

                <!-- Save Path Setting -->
                <div style="padding-top: 16px; border-top: 1px solid var(--color-border);">
                    <p style="font-size: 14px; font-weight: 600; color: var(--slate-700); margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                        <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        저장 경로
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <input
                            type="text"
                            id="save-path-input"
                            class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="./results"
                            value="./results"
                            style="font-family: 'Courier New', monospace; font-size: 12px;"
                        />
                        <button id="btn-browse-save-path" class="btn-outline btn-sm" style="white-space: nowrap;">
                            <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"></path>
                            </svg>
                            찾아보기
                        </button>
                    </div>
                    <p style="font-size: 11px; color: var(--slate-500); margin-top: 6px;">
                        결과는 {저장경로}/{시나리오명}/{타임스탬프}/ 폴더에 저장됩니다
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-save-settings" class="btn-sm btn-primary">저장</button>
            </div>
        </div>
    </div>

    <!-- Scenario List Modal -->
    <div id="scenario-list-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 800px; max-height: 600px; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div class="modal-header">
                <h3 class="modal-title">시나리오 목록</h3>
                <button class="modal-close" id="btn-close-scenario-list">&times;</button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <div id="scenario-list-container">
                    <!-- Scenarios will be rendered here -->
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-secondary" id="btn-new-scenario-from-list" onclick="window.macroApp.createNewScenario()">
                    새 시나리오
                </button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="btn-close-scenario-modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div id="ai-analysis-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title">AI 실패 분석</h3>
                <button id="btn-close-ai-analysis" class="modal-close">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(80vh - 120px);">
                <div id="ai-analysis-loading" style="display: none; text-align: center; padding: 2rem;">
                    <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>
                    <p style="color: var(--slate-600);">AI 분석 중...</p>
                </div>
                <div id="ai-analysis-error" style="display: none; padding: 1rem; background: var(--red-50); border-radius: 8px; color: var(--red-700);">
                </div>
                <div id="ai-analysis-result" style="display: none;">
                    <div id="ai-analysis-summary" style="padding: 1rem; background: var(--slate-100); border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--slate-500);">Summary</h4>
                        <p id="ai-summary-text" style="margin: 0; font-weight: 500;"></p>
                    </div>
                    <div id="ai-analysis-root-cause" style="padding: 1rem; background: var(--amber-50); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0; font-size: 0.875rem; color: var(--amber-700);">Root Cause</h4>
                            <span id="ai-confidence" class="badge" style="font-size: 0.75rem;"></span>
                        </div>
                        <p id="ai-root-cause-text" style="margin: 0;"></p>
                    </div>
                    <div id="ai-analysis-recommendations" style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem; font-size: 0.875rem; color: var(--slate-500);">Recommendations</h4>
                        <div id="ai-recommendations-list"></div>
                    </div>
                    <div id="ai-analysis-insights" style="padding: 1rem; background: var(--blue-50); border-radius: 8px;">
                        <h4 style="margin: 0 0 0.5rem; font-size: 0.875rem; color: var(--blue-700);">Additional Insights</h4>
                        <ul id="ai-insights-list" style="margin: 0; padding-left: 1.25rem;"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-close-ai-modal" class="btn-sm btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <script src="macro-builder-app.js"></script>
</body>
</html>
