<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data:; img-src 'self' data: blob: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' data:">
    <title>Vision Auto v2 - Macro Editor</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/macro-editor-layout.css">
    <link rel="stylesheet" href="styles/timeline-editor.css">
    <link rel="stylesheet" href="styles/properties-panel.css">
</head>
<body>
    <!-- Macro Editor Layout -->
    <div class="macro-editor-layout">
        <!-- Editor Toolbar -->
        <header class="editor-toolbar">
            <!-- Left Section: App Info & Device -->
            <div class="toolbar-section toolbar-left">
                <div class="toolbar-title">
                    <span class="app-icon">⚡</span>
                    <span>Vision Auto</span>
                    <span class="editor-badge badge-primary">v2.0</span>
                </div>

                <div class="toolbar-device-selector" id="toolbar-device">
                    <span class="device-icon" id="device-status-icon">🔴</span>
                    <span class="device-name" id="device-status-name">연결 안 됨</span>
                    <button class="device-change-btn" onclick="macroEditor.showDeviceModal()">변경</button>
                </div>
            </div>

            <!-- Center Section: Main Actions -->
            <div class="toolbar-section toolbar-center">
                <button class="toolbar-btn btn-primary" id="btn-run-macro" onclick="macroEditor.runCurrentMacro()" disabled>
                    <span class="btn-icon">▶</span>
                    <span>실행</span>
                </button>
                <button class="toolbar-btn" id="btn-stop-macro" onclick="macroEditor.stopMacro()" disabled>
                    <span class="btn-icon">⏸</span>
                    <span>중지</span>
                </button>
                <button class="toolbar-btn btn-success" id="btn-save-macro" onclick="macroEditor.saveMacro()">
                    <span class="btn-icon">💾</span>
                    <span>저장</span>
                </button>
                <button class="toolbar-btn" onclick="macroEditor.importMacro()">
                    <span class="btn-icon">📂</span>
                    <span>불러오기</span>
                </button>
                <button class="toolbar-btn" onclick="macroEditor.exportMacro()">
                    <span class="btn-icon">📤</span>
                    <span>내보내기</span>
                </button>
            </div>

            <!-- Right Section: Settings & Info -->
            <div class="toolbar-section toolbar-right">
                <button class="toolbar-btn" onclick="macroEditor.toggleDebugMode()">
                    <span class="btn-icon">🧪</span>
                    <span>디버그</span>
                </button>
                <button class="toolbar-btn" onclick="macroEditor.showSettings()">
                    <span class="btn-icon">⚙️</span>
                    <span>설정</span>
                </button>
            </div>
        </header>

        <!-- Editor Main - 3 Column Layout -->
        <main class="editor-main">
            <!-- Left Panel: Macro List -->
            <aside class="editor-panel macro-list-panel">
                <div class="editor-panel-header">
                    <h3 class="editor-panel-title">매크로 목록</h3>
                    <div class="editor-panel-actions">
                        <button class="toolbar-btn" style="padding: 4px 8px; font-size: 11px;" onclick="macroListPanel.refresh()">
                            <span>🔄</span>
                        </button>
                    </div>
                </div>
                <div class="editor-panel-content" id="macro-list-content">
                    <!-- Search Box -->
                    <div style="padding: 12px;">
                        <input
                            type="text"
                            id="macro-search-input"
                            class="property-input"
                            placeholder="🔍 매크로 검색..."
                            oninput="macroListPanel.search(this.value)"
                        >
                    </div>

                    <!-- Macro Items Container -->
                    <div id="macro-list-items" style="padding: 0 12px 12px;">
                        <!-- Macro items will be rendered here -->
                        <div class="editor-empty-state">
                            <div class="empty-icon">📋</div>
                            <div class="empty-title">매크로가 없습니다</div>
                            <div class="empty-description">새 매크로를 만들어 시작하세요</div>
                        </div>
                    </div>

                    <!-- Add Macro Button -->
                    <div style="padding: 12px; border-top: 1px solid var(--editor-border);">
                        <button class="add-action-btn" onclick="macroListPanel.createNewMacro()">
                            <span class="btn-icon">➕</span>
                            <span>새 매크로</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Timeline Editor -->
            <section class="editor-panel timeline-editor-panel">
                <div class="editor-panel-header">
                    <h3 class="editor-panel-title">
                        액션 타임라인
                        <span class="editor-badge" id="timeline-action-count">0개</span>
                    </h3>
                    <div class="editor-panel-actions">
                        <button class="toolbar-btn" style="padding: 4px 8px; font-size: 11px;" onclick="timelineEditor.clearAll()">
                            <span>🗑️ 전체 삭제</span>
                        </button>
                    </div>
                </div>

                <!-- Timeline Header -->
                <div class="timeline-header">
                    <div class="timeline-stats">
                        <div class="timeline-stat">
                            <span>총 액션:</span>
                            <span class="stat-value" id="stat-total-actions">0</span>
                        </div>
                        <div class="timeline-stat">
                            <span>예상 시간:</span>
                            <span class="stat-value" id="stat-estimated-time">0초</span>
                        </div>
                    </div>
                </div>

                <div class="editor-panel-content">
                    <!-- Timeline Container -->
                    <div class="timeline-container" id="timeline-container">
                        <!-- Action cards will be rendered here -->
                        <div class="timeline-empty">
                            <div class="empty-icon">🎬</div>
                            <div class="empty-title">액션이 없습니다</div>
                            <div class="empty-description">
                                아래 버튼을 클릭하거나<br>
                                화면을 클릭하여 액션을 추가하세요
                            </div>
                            <button class="toolbar-btn btn-primary" onclick="timelineEditor.showAddActionModal()" style="margin-top: 16px;">
                                <span class="btn-icon">➕</span>
                                <span>액션 추가</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Action Button (Fixed Bottom) -->
                <div style="padding: 12px; border-top: 1px solid var(--editor-border); background: var(--editor-bg-tertiary);">
                    <button class="add-action-btn" onclick="timelineEditor.showAddActionModal()">
                        <span class="btn-icon">➕</span>
                        <span>액션 추가</span>
                    </button>
                </div>
            </section>

            <!-- Right Panel: Properties & Preview -->
            <aside class="editor-panel properties-panel" id="properties-panel">
                <div class="editor-panel-header">
                    <h3 class="editor-panel-title">속성</h3>
                    <div class="editor-panel-actions">
                        <button class="toolbar-btn" style="padding: 4px 8px; font-size: 11px;" onclick="propertiesPanel.testAction()">
                            <span>▶ 테스트</span>
                        </button>
                    </div>
                </div>

                <div class="properties-content" id="properties-content">
                    <!-- Properties form will be rendered here -->
                    <div class="properties-empty">
                        <div class="empty-icon">⚙️</div>
                        <div class="empty-title">속성 없음</div>
                        <div class="empty-description">
                            액션을 선택하면<br>
                            속성을 편집할 수 있습니다
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-section" id="preview-section" style="display: none;">
                    <div class="preview-title">미리보기</div>
                    <div class="preview-canvas-wrapper">
                        <canvas id="preview-canvas" class="preview-canvas"></canvas>
                        <div class="preview-overlay" id="preview-overlay">
                            <!-- Preview markers will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Property Actions -->
                <div class="property-actions" id="property-actions" style="display: none;">
                    <button class="property-action-btn" onclick="propertiesPanel.cancelEdit()">취소</button>
                    <button class="property-action-btn btn-primary" onclick="propertiesPanel.applyChanges()">적용</button>
                </div>
            </aside>
        </main>
    </div>

    <!-- Device Connection Modal (Hidden by default) -->
    <div id="device-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>디바이스 연결</h3>
                <button class="modal-close" onclick="macroEditor.closeDeviceModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Device connection UI will be here -->
                <div class="protocol-selector">
                    <label class="protocol-radio">
                        <input type="radio" name="protocol" value="adb" checked onchange="macroEditor.onProtocolChange('adb')">
                        <span class="protocol-label">ADB</span>
                    </label>
                    <label class="protocol-radio">
                        <input type="radio" name="protocol" value="ccnc" onchange="macroEditor.onProtocolChange('ccnc')">
                        <span class="protocol-label">ccNC</span>
                    </label>
                </div>

                <div id="adb-connection-area" class="connection-area" style="margin-top: 16px;">
                    <label>연결할 ADB 장치를 선택하세요</label>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <select id="adb-device-list" class="property-input" style="flex: 1;">
                            <option value="">장치를 선택하세요</option>
                        </select>
                        <button class="toolbar-btn" onclick="macroEditor.scanDevices()">새로고침</button>
                    </div>
                    <button id="adb-connect-btn" class="toolbar-btn btn-primary" onclick="macroEditor.connectADB()" style="width: 100%; margin-top: 12px;">연결</button>
                </div>

                <div id="ccnc-connection-area" class="connection-area" style="display: none; margin-top: 16px;">
                    <label>연결할 장치 IP를 입력하세요</label>
                    <input type="text" id="ccnc-host" value="localhost" placeholder="예: 192.168.0.10" class="property-input" style="margin-top: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                        <div>
                            <label style="font-size: 12px;">포트</label>
                            <input type="number" id="ccnc-port" value="20000" class="property-input">
                        </div>
                        <div>
                            <label style="font-size: 12px;">FPS</label>
                            <input type="number" id="ccnc-fps" value="30" min="1" max="60" class="property-input">
                        </div>
                    </div>
                    <button id="ccnc-connect-btn" class="toolbar-btn btn-primary" onclick="macroEditor.connectCCNC()" style="width: 100%; margin-top: 12px;">연결</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden canvas for main screen mirroring -->
    <canvas id="screen-canvas" style="display: none;"></canvas>

    <!-- Scripts: Load order is important -->
    <!-- Stores -->
    <script src="stores/DeviceStore.js"></script>
    <script src="stores/ScreenStore.js"></script>
    <script src="stores/MacroStore.js"></script>
    <script src="stores/ActionStore.js"></script>

    <!-- Services -->
    <script src="services/EventBus.js"></script>
    <script src="services/IPCService.js"></script>

    <!-- Components (old architecture - still needed for IPC) -->
    <script src="components/DevicePanel.js"></script>
    <script src="components/ScreenPanel.js"></script>
    <script src="components/MacroPanel.js"></script>
    <script src="components/ActionPanel.js"></script>

    <!-- New Editor Components (to be created) -->
    <script src="editor/MacroListPanel.js"></script>
    <script src="editor/TimelineEditor.js"></script>
    <script src="editor/PropertiesPanel.js"></script>
    <script src="editor/MacroEditor.js"></script>

    <!-- Initialize -->
    <script>
        // Initialize the macro editor when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Editor] Initializing Macro Editor...');
            window.macroEditor = new MacroEditor();
            window.macroEditor.init();
        });
    </script>
</body>
</html>
